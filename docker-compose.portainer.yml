# =====================================================
# BBT CONNECT - DOCKER COMPOSE PARA PORTAINER
# Versão ajustada para evitar conflitos com outras stacks
# =====================================================

version: '3.8'

services:
  # ======== FRONTEND ========
  bbt-frontend:
    build:
      context: ./packages/frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:3010}
        - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:3010}
    image: bbt-connect-frontend:latest
    container_name: bbt-connect-frontend
    restart: unless-stopped
    ports:
      # ⚠️ AJUSTAR: Porta externa para o frontend
      # Use uma porta livre no seu servidor (ex: 3009, 8080, 8090)
      - "${FRONTEND_PORT:-3009}:80"
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:3010}
      - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:3010}
    depends_on:
      bbt-backend:
        condition: service_healthy
    networks:
      - bbt-connect-network
    labels:
      - "com.docker.compose.project=bbt-connect"

  # ======== BACKEND ========
  bbt-backend:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile
    image: bbt-connect-backend:latest
    container_name: bbt-connect-backend
    restart: unless-stopped
    ports:
      # ⚠️ AJUSTAR: Porta externa para o backend
      # Use uma porta livre (ex: 3010, 3100, 4000)
      - "${BACKEND_PORT:-3010}:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - BASE_URL=${BACKEND_URL:-http://localhost:3010}
      - CORS_ORIGIN=${FRONTEND_URL:-http://localhost:3009}
      - POSTGRES_HOST=bbt-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-bbt_connect}
      - POSTGRES_USER=${POSTGRES_USER:-bbt_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - UPLOAD_DIR=/app/uploads
      - MAX_FILE_SIZE=52428800
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX=100
    volumes:
      - bbt_uploads:/app/uploads
      - bbt_logs:/app/logs
    depends_on:
      bbt-postgres:
        condition: service_healthy
    networks:
      - bbt-connect-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    labels:
      - "com.docker.compose.project=bbt-connect"

  # ======== POSTGRESQL ========
  bbt-postgres:
    image: postgres:15-alpine
    container_name: bbt-connect-postgres
    restart: unless-stopped
    ports:
      # ⚠️ AJUSTAR: Porta externa do PostgreSQL
      # Use uma porta livre (ex: 5433, 5434, etc)
      - "${POSTGRES_PORT_EXTERNAL:-5433}:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-bbt_connect}
      - POSTGRES_USER=${POSTGRES_USER:-bbt_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - bbt_postgres:/var/lib/postgresql/data
      - ./packages/backend/src/db/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - bbt-connect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bbt_user} -d ${POSTGRES_DB:-bbt_connect}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - "com.docker.compose.project=bbt-connect"

# ======== VOLUMES (nomes únicos) ========
volumes:
  bbt_postgres:
    driver: local
    name: bbt_connect_postgres_data
  bbt_uploads:
    driver: local
    name: bbt_connect_uploads_data
  bbt_logs:
    driver: local
    name: bbt_connect_logs_data

# ======== NETWORK (nome único) ========
networks:
  bbt-connect-network:
    driver: bridge
    name: bbt_connect_network
